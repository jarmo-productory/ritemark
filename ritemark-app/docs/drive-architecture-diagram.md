# Drive API Integration - Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RiteMark App                              â”‚
â”‚                    (Browser - React + TypeScript)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Component Layer                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   App.tsx    â”‚  â”‚ AuthModal    â”‚  â”‚ DriveFile    â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚   Picker     â”‚ (NEW)     â”‚
â”‚  â”‚ â€¢ title      â”‚  â”‚ â€¢ OAuth Flow â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ â€¢ content    â”‚  â”‚ â€¢ Token Mgmt â”‚  â”‚ â€¢ List Files â”‚          â”‚
â”‚  â”‚ â€¢ fileId     â”‚â—„â”€â”¤ â€¢ User Auth  â”‚  â”‚ â€¢ Search     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                                         â”‚
â”‚         â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚  Editor.tsx  â”‚  â”‚ SaveStatus   â”‚ (NEW)                       â”‚
â”‚  â”‚              â”‚  â”‚              â”‚                              â”‚
â”‚  â”‚ â€¢ TipTap     â”‚  â”‚ â€¢ isSaving   â”‚                             â”‚
â”‚  â”‚ â€¢ onChange   â”‚  â”‚ â€¢ lastSaved  â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Hooks Layer                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  useAuth()   â”‚              â”‚ useDriveSync â”‚ (NEW)           â”‚
â”‚  â”‚              â”‚              â”‚              â”‚                  â”‚
â”‚  â”‚ â€¢ user       â”‚              â”‚ â€¢ Auto-save  â”‚                 â”‚
â”‚  â”‚ â€¢ login()    â”‚              â”‚ â€¢ Debounce   â”‚                 â”‚
â”‚  â”‚ â€¢ logout()   â”‚              â”‚ â€¢ isSaving   â”‚                 â”‚
â”‚  â”‚ â€¢ error      â”‚              â”‚ â€¢ lastSaved  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                             â”‚                          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                       â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Service Layer                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   TokenManager       â”‚      â”‚   DriveApiService      â”‚ (NEW) â”‚
â”‚  â”‚                      â”‚      â”‚                        â”‚       â”‚
â”‚  â”‚ â€¢ getAccessToken()   â”‚â—„â”€â”€â”€â”€â”€â”¤ â€¢ createFile()         â”‚       â”‚
â”‚  â”‚ â€¢ isTokenExpired()   â”‚      â”‚ â€¢ updateFile()         â”‚       â”‚
â”‚  â”‚ â€¢ refreshToken()     â”‚      â”‚ â€¢ getFile()            â”‚       â”‚
â”‚  â”‚ â€¢ clearTokens()      â”‚      â”‚ â€¢ listFiles()          â”‚       â”‚
â”‚  â”‚                      â”‚      â”‚ â€¢ deleteFile()         â”‚       â”‚
â”‚  â”‚ Storage:             â”‚      â”‚                        â”‚       â”‚
â”‚  â”‚ sessionStorage       â”‚      â”‚ Error Handling:        â”‚       â”‚
â”‚  â”‚ â€¢ ritemark_oauth_    â”‚      â”‚ â€¢ Retry logic          â”‚       â”‚
â”‚  â”‚   tokens             â”‚      â”‚ â€¢ Rate limiting        â”‚       â”‚
â”‚  â”‚ â€¢ expiresAt          â”‚      â”‚ â€¢ Network errors       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                          â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Google Drive API (v3)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  Base URL: https://www.googleapis.com/drive/v3                  â”‚
â”‚                                                                   â”‚
â”‚  Endpoints:                                                      â”‚
â”‚  â€¢ POST   /files           (Create file)                         â”‚
â”‚  â€¢ PATCH  /files/{id}      (Update file)                        â”‚
â”‚  â€¢ GET    /files/{id}      (Get metadata)                       â”‚
â”‚  â€¢ GET    /files?q=...     (List files)                         â”‚
â”‚  â€¢ DELETE /files/{id}      (Delete file)                        â”‚
â”‚                                                                   â”‚
â”‚  Authentication:                                                 â”‚
â”‚  â€¢ Header: Authorization: Bearer {access_token}                 â”‚
â”‚  â€¢ Scope: https://www.googleapis.com/auth/drive.file           â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagrams

### 1. User Authentication Flow

```
User                 AuthModal           TokenManager       Google OAuth
  â”‚                     â”‚                     â”‚                  â”‚
  â”‚ Click "Sign in"     â”‚                     â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚                  â”‚
  â”‚                     â”‚ initTokenClient()   â”‚                  â”‚
  â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
  â”‚                     â”‚                     â”‚ OAuth Popup      â”‚
  â”‚                     â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                     â”‚                     â”‚                  â”‚
  â”‚  [OAuth Consent]    â”‚                     â”‚                  â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                     â”‚                     â”‚                  â”‚
  â”‚  Grant Access       â”‚                     â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚                  â”‚
  â”‚                     â”‚                     â”‚ Access Token     â”‚
  â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                     â”‚                     â”‚                  â”‚
  â”‚                     â”‚ storeTokens()       â”‚                  â”‚
  â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
  â”‚                     â”‚                     â”‚ Store in         â”‚
  â”‚                     â”‚                     â”‚ sessionStorage   â”‚
  â”‚                     â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
  â”‚                     â”‚                     â”‚          â”‚       â”‚
  â”‚                     â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
  â”‚                     â”‚ Reload Page         â”‚                  â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                  â”‚
  â”‚                     â”‚                     â”‚                  â”‚
```

---

### 2. Document Auto-Save Flow

```
User Types          Editor.tsx       useDriveSync      DriveApiService    Google Drive
   â”‚                   â”‚                  â”‚                  â”‚                â”‚
   â”‚ Edit content      â”‚                  â”‚                  â”‚                â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                  â”‚                â”‚
   â”‚                   â”‚ onChange(text)   â”‚                  â”‚                â”‚
   â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                â”‚
   â”‚                   â”‚                  â”‚ Start timer      â”‚                â”‚
   â”‚                   â”‚                  â”‚ (3s debounce)    â”‚                â”‚
   â”‚                   â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                â”‚
   â”‚                   â”‚                  â”‚        â”‚         â”‚                â”‚
   â”‚ [User stops       â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                â”‚
   â”‚  typing]          â”‚                  â”‚                  â”‚                â”‚
   â”‚                   â”‚                  â”‚ setIsSaving(true)â”‚                â”‚
   â”‚                   â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                â”‚
   â”‚                   â”‚                  â”‚          â”‚       â”‚                â”‚
   â”‚                   â”‚ Show "Saving..." â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                â”‚
   â”‚                   â”‚                  â”‚ updateFile()     â”‚                â”‚
   â”‚                   â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
   â”‚                   â”‚                  â”‚                  â”‚ PATCH /files/  â”‚
   â”‚                   â”‚                  â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                   â”‚                  â”‚                  â”‚                â”‚
   â”‚                   â”‚                  â”‚                  â”‚ 200 OK         â”‚
   â”‚                   â”‚                  â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                   â”‚                  â”‚ Success          â”‚                â”‚
   â”‚                   â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
   â”‚                   â”‚                  â”‚ setLastSaved()   â”‚                â”‚
   â”‚                   â”‚                  â”‚ setIsSaving(false)                â”‚
   â”‚                   â”‚ Show "Saved âœ“"  â”‚                  â”‚                â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                â”‚
   â”‚                   â”‚                  â”‚                  â”‚                â”‚
```

---

### 3. File Loading Flow

```
User               DriveFilePicker  DriveApiService   Google Drive    App.tsx
 â”‚                       â”‚                â”‚               â”‚             â”‚
 â”‚ Click "Open"          â”‚                â”‚               â”‚             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚               â”‚             â”‚
 â”‚                       â”‚ listFiles()    â”‚               â”‚             â”‚
 â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚             â”‚
 â”‚                       â”‚                â”‚ GET /files?q= â”‚             â”‚
 â”‚                       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
 â”‚                       â”‚                â”‚               â”‚             â”‚
 â”‚                       â”‚                â”‚ File list     â”‚             â”‚
 â”‚                       â”‚ Show files     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
 â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚             â”‚
 â”‚ [Select file]         â”‚                â”‚               â”‚             â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚               â”‚             â”‚
 â”‚                       â”‚                â”‚               â”‚             â”‚
 â”‚ Click file            â”‚                â”‚               â”‚             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚               â”‚             â”‚
 â”‚                       â”‚ getFile(id)    â”‚               â”‚             â”‚
 â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚             â”‚
 â”‚                       â”‚                â”‚ GET /files/id â”‚             â”‚
 â”‚                       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
 â”‚                       â”‚                â”‚               â”‚             â”‚
 â”‚                       â”‚                â”‚ File data     â”‚             â”‚
 â”‚                       â”‚ File loaded    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
 â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚             â”‚
 â”‚                       â”‚ onSelect(file) â”‚               â”‚             â”‚
 â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                       â”‚                â”‚               â”‚ setFileId() â”‚
 â”‚                       â”‚                â”‚               â”‚ setTitle()  â”‚
 â”‚                       â”‚                â”‚               â”‚ setText()   â”‚
 â”‚                       â”‚                â”‚               â”‚             â”‚
 â”‚ [Editor shows content]â”‚                â”‚               â”‚             â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                       â”‚                â”‚               â”‚             â”‚
```

---

## State Management Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        App.tsx                               â”‚
â”‚                     (Component State)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Local State:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ title: string            (Document title)        â”‚       â”‚
â”‚  â”‚ text: string             (HTML content)          â”‚       â”‚
â”‚  â”‚ fileId: string | null    (Drive file ID)  (NEW)  â”‚       â”‚
â”‚  â”‚ hasHeadings: boolean     (TOC visibility)        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                               â”‚
â”‚  Context (via AuthProvider):                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ user: GoogleUser | null                          â”‚       â”‚
â”‚  â”‚ isAuthenticated: boolean                         â”‚       â”‚
â”‚  â”‚ isLoading: boolean                               â”‚       â”‚
â”‚  â”‚ error: string | null                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                               â”‚
â”‚  Drive Sync Hook (useDriveSync):                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ isSaving: boolean                         (NEW)  â”‚       â”‚
â”‚  â”‚ lastSaved: Date | null                    (NEW)  â”‚       â”‚
â”‚  â”‚ error: DriveError | null                  (NEW)  â”‚       â”‚
â”‚  â”‚ saveToGDrive: () => Promise<void>         (NEW)  â”‚       â”‚
â”‚  â”‚ loadFromGDrive: (id) => Promise<DriveFile>(NEW)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Token Flow & Security

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Token Lifecycle                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Authentication:
   Google OAuth â†’ Access Token (expires in 3600s = 1 hour)

2. Storage:
   sessionStorage.setItem('ritemark_oauth_tokens', {
     access_token: "ya29.a0...",
     expires_in: 3600,
     expiresAt: 1699999999999,  // Current time + 3600s
     scope: "openid email profile https://www.googleapis.com/auth/drive.file"
   })

3. Token Retrieval (before each API call):
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ tokenManager.getAccessToken()           â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ 1. Read from sessionStorage             â”‚
   â”‚ 2. Check if expiresAt > Date.now()      â”‚
   â”‚    â”œâ”€ YES: Return token                 â”‚
   â”‚    â””â”€ NO:  Attempt refresh (TODO)       â”‚
   â”‚           â””â”€ Currently: Force re-auth   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. Token Refresh (âš ï¸ NOT IMPLEMENTED):
   Current: User must re-authenticate after 1 hour
   Future: Use refresh_token to get new access_token

5. Token Expiry Buffer:
   Refresh 5 minutes BEFORE expiry (line 15 in tokenManager.ts)
   Buffer = 5 * 60 * 1000 = 300,000ms

6. Security:
   âœ… sessionStorage (cleared on tab close)
   âœ… HTTPS required for OAuth redirect
   âœ… State parameter for CSRF protection
   âœ… Minimal scope (drive.file, not full drive)
   âš ï¸ Production: Should use httpOnly cookies
```

---

## Error Handling Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Error Flow                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Drive API Call
      â”‚
      â–¼
  Try/Catch
      â”‚
      â”œâ”€â”€â–º Success
      â”‚    â””â”€â–º Return result
      â”‚
      â””â”€â”€â–º Error
           â”‚
           â–¼
    Classify Error
           â”‚
           â”œâ”€â”€â–º 401 Unauthorized
           â”‚    â”œâ”€â–º Clear tokens
           â”‚    â”œâ”€â–º Trigger re-auth
           â”‚    â””â”€â–º Show: "Session expired, please sign in"
           â”‚
           â”œâ”€â”€â–º 403 Forbidden
           â”‚    â””â”€â–º Show: "Permission denied"
           â”‚
           â”œâ”€â”€â–º 404 Not Found
           â”‚    â””â”€â–º Show: "File not found"
           â”‚
           â”œâ”€â”€â–º 429 Rate Limit
           â”‚    â”œâ”€â–º Wait (exponential backoff)
           â”‚    â””â”€â–º Retry request
           â”‚
           â”œâ”€â”€â–º Network Error
           â”‚    â”œâ”€â–º Queue for retry
           â”‚    â””â”€â–º Show: "Offline - changes will sync when online"
           â”‚
           â””â”€â”€â–º Unknown Error
                â””â”€â–º Log error
                â””â”€â–º Show: "Error saving, please try again"

Component Display:
      â”‚
      â–¼
  SaveStatus Component
      â”‚
      â”œâ”€â”€â–º isSaving=true  â†’ "Saving..."
      â”œâ”€â”€â–º success       â†’ "Saved âœ“"
      â””â”€â”€â–º error         â†’ "Error saving [Retry]"
```

---

## File Structure Impact

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ AuthModal.tsx       âœ… Existing - OAuth + Drive scope
â”‚   â”‚   â””â”€â”€ AuthStatus.tsx      âœ… Existing - User profile
â”‚   â”‚
â”‚   â”œâ”€â”€ drive/                  âš ï¸ NEW DIRECTORY
â”‚   â”‚   â”œâ”€â”€ DriveFilePicker.tsx   ğŸ†• Browse Drive files
â”‚   â”‚   â”œâ”€â”€ SaveStatus.tsx        ğŸ†• Show sync status
â”‚   â”‚   â””â”€â”€ FileMetadata.tsx      ğŸ†• Display file info
â”‚   â”‚
â”‚   â””â”€â”€ Editor.tsx              âœ… Existing - Add auto-save trigger
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useAuth.ts              âœ… Existing
â”‚   â”œâ”€â”€ useDriveSync.ts         ğŸ†• Auto-save hook
â”‚   â””â”€â”€ useDriveFiles.ts        ğŸ†• File list management
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ tokenManager.ts     âœ… Existing - Token CRUD
â”‚   â”‚   â””â”€â”€ googleAuth.ts       âœ… Existing - OAuth flow
â”‚   â”‚
â”‚   â””â”€â”€ drive/                  âš ï¸ NEW DIRECTORY
â”‚       â”œâ”€â”€ driveApi.ts           ğŸ†• Drive API service
â”‚       â”œâ”€â”€ driveSync.ts          ğŸ†• Sync coordination
â”‚       â””â”€â”€ driveCache.ts         ğŸ†• Offline cache
â”‚
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ auth.ts                 âœ… Existing - OAuth types
â”‚   â””â”€â”€ drive.ts                ğŸ†• Drive type definitions
â”‚
â””â”€â”€ App.tsx                     âœ… Existing - Add Drive state

Legend:
  âœ… Existing file (no changes)
  âœ… Existing file (needs updates)
  âš ï¸ New directory needed
  ğŸ†• New file needed
```

---

## Integration Checklist

### Phase 1: Foundation
- [ ] Create `/src/types/drive.ts` with type definitions
- [ ] Create `/src/services/drive/driveApi.ts` service class
- [ ] Test Drive API calls with existing OAuth token
- [ ] Implement error handling and retry logic

### Phase 2: Auto-Save
- [ ] Create `/src/hooks/useDriveSync.ts` hook
- [ ] Add fileId state to `App.tsx`
- [ ] Implement debounced auto-save (3-5 seconds)
- [ ] Create `SaveStatus.tsx` component
- [ ] Show sync status in UI

### Phase 3: File Management
- [ ] Create `DriveFilePicker.tsx` component
- [ ] Implement file list with search
- [ ] Add "Open" button to app header
- [ ] Load selected file into editor
- [ ] Handle file not found errors

### Phase 4: Polish
- [ ] Implement token refresh flow
- [ ] Add offline mode support
- [ ] Implement conflict resolution
- [ ] Add keyboard shortcuts (Cmd+S to save)
- [ ] Write comprehensive tests

---

## Performance Considerations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Performance Optimizations                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Auto-Save Debouncing:
   User types â†’ Wait 3 seconds â†’ Save
   â”œâ”€â–º Reduces API calls (saves quota)
   â”œâ”€â–º Improves typing performance
   â””â”€â–º Prevents "too many requests" errors

2. File List Caching:
   First load â†’ Fetch from Drive â†’ Cache in memory
   Subsequent loads â†’ Use cached data â†’ Refresh in background

3. Token Caching:
   Store in sessionStorage (not localStorage)
   â””â”€â–º Faster access than repeated OAuth flows
   â””â”€â–º Cleared automatically on tab close (security)

4. Lazy Loading:
   â”œâ”€â–º DriveFilePicker: Load only when opened
   â”œâ”€â–º File content: Stream large files
   â””â”€â–º Thumbnails: Load on scroll (virtual list)

5. Request Batching:
   Multiple file operations â†’ Batch into single request
   â””â”€â–º Drive API supports batch requests

6. Error Recovery:
   Network error â†’ Queue request â†’ Retry when online
   â””â”€â–º Prevents data loss during connectivity issues
```

---

## Monitoring & Observability

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Logging & Metrics                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Development:
  âœ… Console logs for Drive API calls
  âœ… Token expiry warnings
  âœ… Error stack traces

Production (Future):
  ğŸ“Š Track Drive API response times
  ğŸ“Š Monitor token refresh failures
  ğŸ“Š Count auto-save successes/failures
  ğŸ“Š Track user engagement (files created, edited)

Error Tracking:
  ğŸ”´ 401 Unauthorized (token expired)
  ğŸ”´ 403 Forbidden (permission denied)
  ğŸ”´ 429 Rate limit exceeded
  ğŸ”´ Network errors
  ğŸ”´ File conflicts

User Feedback:
  ğŸ’¬ "Saving..." â†’ In progress
  âœ… "Saved 2 minutes ago" â†’ Success
  âš ï¸ "Offline - changes not saved" â†’ Warning
  âŒ "Error saving" [Retry] â†’ Error with action
```
